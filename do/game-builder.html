<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>package builder ‚Äì winded.vertigo</title>
  <meta name="description" content="Build your custom learning experience package at the winded.vertigo studio.">

  <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --cadet-blue: #273248;
      --redwood: #b15043;
      --burnt-sienna: #cb7858;
      --champagne: #ffebd2;
      --white: #ffffff;
      --periwinkle: #5872cb;
      --seafoam: #58cbb2;
      --light-lavender: #d5d2ff;
      --light-cyan: #d2fdff;
      --font-display: 'Space Mono', monospace;
      --font-ui: 'Inter', sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: var(--font-ui); background: #1e2530; color: var(--champagne); }

    .game-container { position: relative; width: 100vw; height: 100vh; }
    #scene-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

    /* Header */
    .header-overlay {
      position: absolute; top: 0; left: 0; right: 0; z-index: 10;
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 24px;
      background: linear-gradient(180deg, rgba(39, 50, 72, 0.95) 0%, transparent 100%);
      pointer-events: none;
    }
    .header-overlay > * { pointer-events: auto; }
    .shop-title {
      font-family: var(--font-display); font-size: 13px;
      color: var(--champagne); letter-spacing: 2px; text-transform: lowercase;
    }
    .step-indicator { display: flex; gap: 10px; align-items: center; }
    .step-pip {
      width: 10px; height: 10px; border-radius: 50%;
      border: 2px solid var(--burnt-sienna); background: transparent;
      transition: all 0.3s ease;
    }
    .step-pip.active { background: var(--burnt-sienna); box-shadow: 0 0 8px var(--burnt-sienna); }
    .step-pip.complete { background: var(--seafoam); border-color: var(--seafoam); }
    .exit-btn {
      font-family: var(--font-display); font-size: 11px;
      color: var(--champagne); background: rgba(39, 50, 72, 0.8);
      border: 1px solid var(--burnt-sienna); padding: 8px 16px;
      cursor: pointer; text-decoration: none; transition: all 0.2s ease;
    }
    .exit-btn:hover { background: var(--burnt-sienna); color: var(--cadet-blue); }

    /* Inventory Panel */
    .inventory-pouch {
      position: absolute; bottom: 20px; right: 20px; z-index: 20; width: 300px;
      background: rgba(39, 50, 72, 0.95); border: 1px solid var(--burnt-sienna);
      border-radius: 8px; padding: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .pouch-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; padding-bottom: 8px;
      border-bottom: 1px solid rgba(203, 120, 88, 0.3);
    }
    .pouch-title {
      font-family: var(--font-display); font-size: 10px;
      color: var(--burnt-sienna); letter-spacing: 2px; text-transform: uppercase;
    }
    .pouch-subtitle { font-size: 10px; color: var(--champagne); opacity: 0.6; }
    .inventory-section { margin-bottom: 10px; }
    .section-label {
      font-family: var(--font-display); font-size: 9px;
      color: var(--champagne); opacity: 0.5; letter-spacing: 1px;
      text-transform: uppercase; margin-bottom: 5px;
    }
    .slot-row { display: flex; gap: 6px; }
    .inventory-slot {
      width: 44px; height: 44px;
      background: rgba(30, 37, 48, 0.8); border: 1px solid rgba(203, 120, 88, 0.3);
      border-radius: 6px; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease; position: relative;
    }
    .inventory-slot.single { width: 70px; }
    .inventory-slot.drop-target {
      border-color: var(--seafoam); background: rgba(88, 203, 178, 0.15);
      box-shadow: 0 0 12px rgba(88, 203, 178, 0.3);
    }
    .inventory-slot.filled { border-color: var(--burnt-sienna); background: rgba(203, 120, 88, 0.1); }
    .slot-item { font-size: 18px; }
    .slot-tooltip {
      position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
      background: var(--cadet-blue); color: var(--champagne);
      padding: 4px 8px; border-radius: 4px; font-size: 9px;
      white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .inventory-slot:hover .slot-tooltip { opacity: 1; }

    /* Stage Prompt */
    .stage-prompt {
      position: absolute; top: 80px; left: 24px; z-index: 15;
      max-width: 320px; background: rgba(39, 50, 72, 0.95);
      border-left: 3px solid var(--burnt-sienna);
      padding: 16px 20px; border-radius: 0 8px 8px 0;
    }
    .prompt-step {
      font-family: var(--font-display); font-size: 10px;
      color: var(--burnt-sienna); letter-spacing: 2px;
      text-transform: uppercase; margin-bottom: 4px;
    }
    .prompt-question {
      font-size: 17px; font-weight: 500; color: var(--champagne);
      margin-bottom: 6px; line-height: 1.3;
    }
    .prompt-hint { font-size: 12px; color: var(--champagne); opacity: 0.6; }
    .prompt-hint em { color: var(--seafoam); font-style: normal; }

    /* Item Label */
    .item-label {
      position: absolute; background: rgba(39, 50, 72, 0.95);
      border: 1px solid var(--burnt-sienna); padding: 8px 12px;
      border-radius: 6px; pointer-events: none; z-index: 25;
      transform: translate(-50%, -100%); margin-top: -12px;
      opacity: 0; transition: opacity 0.2s;
    }
    .item-label.visible { opacity: 1; }
    .item-label-name {
      font-family: var(--font-display); font-size: 12px;
      color: var(--burnt-sienna); white-space: nowrap;
    }
    .item-label-desc {
      font-size: 11px; color: var(--champagne); opacity: 0.7;
      white-space: nowrap; margin-top: 2px;
    }

    /* Continue Button */
    .continue-btn {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      z-index: 20; font-family: var(--font-display); font-size: 12px;
      color: var(--cadet-blue); background: var(--burnt-sienna);
      border: none; padding: 12px 28px; border-radius: 6px;
      cursor: pointer; letter-spacing: 1px; transition: all 0.2s ease;
      display: none;
    }
    .continue-btn:hover { background: var(--champagne); box-shadow: 0 4px 15px rgba(203, 120, 88, 0.4); }
    .continue-btn.visible { display: block; }

    /* Dragging */
    .dragging-item {
      position: fixed; z-index: 100; pointer-events: none;
      font-size: 32px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
      transform: translate(-50%, -50%);
    }
    body.dragging, body.dragging * { cursor: grabbing !important; }

    /* Guide Speech */
    .wizard-speech {
      position: absolute; bottom: 120px; left: 24px; z-index: 15;
      max-width: 280px; background: rgba(39, 50, 72, 0.95);
      border: 1px solid var(--seafoam); padding: 14px 16px;
      border-radius: 8px; opacity: 0; transform: translateY(10px);
      transition: all 0.3s ease;
    }
    .wizard-speech.visible { opacity: 1; transform: translateY(0); }
    .wizard-speech::before {
      content: 'GUIDE'; position: absolute; top: -9px; left: 12px;
      font-family: var(--font-display); font-size: 9px;
      color: var(--seafoam); letter-spacing: 1px;
      background: rgba(39, 50, 72, 1); padding: 2px 8px;
      border: 1px solid var(--seafoam); border-radius: 3px;
    }
    .wizard-text { font-size: 13px; color: var(--champagne); line-height: 1.5; }

    /* Package Summary (Step 5) */
    .package-summary {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 30; width: 90%; max-width: 700px;
      background: rgba(39, 50, 72, 0.98); border: 1px solid var(--burnt-sienna);
      border-radius: 12px; padding: 32px; display: none;
      box-shadow: 0 8px 40px rgba(0,0,0,0.4);
    }
    .package-summary.visible { display: block; }
    .package-header {
      text-align: center; margin-bottom: 24px;
      padding-bottom: 16px; border-bottom: 1px solid rgba(203, 120, 88, 0.3);
    }
    .package-title {
      font-family: var(--font-display); font-size: 18px;
      color: var(--burnt-sienna); letter-spacing: 2px;
      text-transform: uppercase; margin-bottom: 4px;
    }
    .package-subtitle { font-size: 13px; color: var(--champagne); opacity: 0.7; }
    .package-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .package-section {
      background: rgba(30, 37, 48, 0.6); border-radius: 8px;
      padding: 16px; border-left: 3px solid var(--periwinkle);
    }
    .package-section.full-width { grid-column: 1 / -1; }
    .package-section-label {
      font-family: var(--font-display); font-size: 9px;
      color: var(--periwinkle); letter-spacing: 1px;
      text-transform: uppercase; margin-bottom: 8px;
    }
    .package-section-value { font-size: 15px; color: var(--champagne); line-height: 1.5; }
    .package-tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .package-tag {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(203, 120, 88, 0.15); border: 1px solid var(--burnt-sienna);
      padding: 6px 12px; border-radius: 20px; font-size: 12px; color: var(--champagne);
    }
    .package-actions { display: flex; gap: 12px; justify-content: center; }
    .package-btn {
      font-family: var(--font-display); font-size: 12px;
      padding: 12px 24px; border: none; border-radius: 6px;
      cursor: pointer; letter-spacing: 1px; transition: all 0.2s ease;
    }
    .package-btn.primary { background: var(--burnt-sienna); color: var(--cadet-blue); }
    .package-btn.secondary {
      background: transparent; color: var(--champagne);
      border: 1px solid var(--burnt-sienna);
    }
    .package-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(203, 120, 88, 0.3); }

    @media (max-width: 600px) {
      .package-grid { grid-template-columns: 1fr; }
      .inventory-pouch { width: 260px; padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <canvas id="scene-canvas"></canvas>

    <header class="header-overlay">
      <div class="shop-title">winded.vertigo studio</div>
      <div class="step-indicator" id="stepIndicator">
        <div class="step-pip" data-step="1"></div>
        <div class="step-pip" data-step="2"></div>
        <div class="step-pip" data-step="3"></div>
        <div class="step-pip" data-step="4"></div>
        <div class="step-pip" data-step="5"></div>
      </div>
      <a href="../do/" class="exit-btn">‚Üê back</a>
    </header>

    <div class="stage-prompt" id="stagePrompt">
      <div class="prompt-step">step 1 of 5</div>
      <div class="prompt-question">Who is your work focused on?</div>
      <div class="prompt-hint">Select a <em>focus</em> from the display</div>
    </div>

    <div class="wizard-speech" id="wizardSpeech">
      <div class="wizard-text" id="wizardText">Welcome to the studio. Let's configure your experience package together.</div>
    </div>

    <div class="item-label" id="itemLabel">
      <div class="item-label-name"></div>
      <div class="item-label-desc"></div>
    </div>

    <div class="inventory-pouch" id="inventoryPouch">
      <div class="pouch-header">
        <div class="pouch-title">Your Package</div>
        <div class="pouch-subtitle">selections</div>
      </div>
      <div class="inventory-section" id="section-focus">
        <div class="section-label">1. focus</div>
        <div class="slot-row">
          <div class="inventory-slot single" data-section="focus" data-index="0"></div>
        </div>
      </div>
      <div class="inventory-section" id="section-approach">
        <div class="section-label">2. approach</div>
        <div class="slot-row">
          <div class="inventory-slot single" data-section="approach" data-index="0"></div>
        </div>
      </div>
      <div class="inventory-section" id="section-services">
        <div class="section-label">3. services (up to 4)</div>
        <div class="slot-row">
          <div class="inventory-slot" data-section="services" data-index="0"></div>
          <div class="inventory-slot" data-section="services" data-index="1"></div>
          <div class="inventory-slot" data-section="services" data-index="2"></div>
          <div class="inventory-slot" data-section="services" data-index="3"></div>
        </div>
      </div>
      <div class="inventory-section" id="section-goals">
        <div class="section-label">4. goals (up to 3)</div>
        <div class="slot-row">
          <div class="inventory-slot" data-section="goals" data-index="0"></div>
          <div class="inventory-slot" data-section="goals" data-index="1"></div>
          <div class="inventory-slot" data-section="goals" data-index="2"></div>
        </div>
      </div>
    </div>

    <button class="continue-btn" id="continueBtn">Continue ‚Üí</button>

    <!-- Package Summary (Step 5) -->
    <div class="package-summary" id="packageSummary">
      <div class="package-header">
        <div class="package-title">Your Package</div>
        <div class="package-subtitle" id="packageQuadrant">design & deploy</div>
      </div>
      <div class="package-grid">
        <div class="package-section">
          <div class="package-section-label">Focus</div>
          <div class="package-section-value" id="summaryFocus">‚Äî</div>
        </div>
        <div class="package-section">
          <div class="package-section-label">Approach</div>
          <div class="package-section-value" id="summaryApproach">‚Äî</div>
        </div>
        <div class="package-section full-width">
          <div class="package-section-label">Services</div>
          <div class="package-tags" id="summaryServices"></div>
        </div>
        <div class="package-section full-width">
          <div class="package-section-label">Goals</div>
          <div class="package-tags" id="summaryGoals"></div>
        </div>
      </div>
      <div class="package-actions">
        <button class="package-btn secondary" id="resetBtn">Start Over</button>
        <button class="package-btn primary" id="submitBtn">Book a Playdate ‚Üí</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <script>
    // =============================================
    // GAME DATA
    // =============================================
    const STEPS = [
      null,
      {
        id: 'focus', prompt: 'Who is your work focused on?',
        hint: 'Select a <em>focus</em> from the display', single: true,
        items: [
          { value: 'people', icon: 'üë•', label: 'People', desc: 'Human development & learning', color: 0x5872cb },
          { value: 'product', icon: 'üì¶', label: 'Product', desc: 'Tools, toys & experiences', color: 0xcb7858 }
        ]
      },
      {
        id: 'approach', prompt: 'What approach guides your work?',
        hint: 'Select an <em>approach</em> from the display', single: true,
        items: [
          { value: 'design', icon: '‚ú®', label: 'Design', desc: 'Creating new solutions', color: 0x58cbb2 },
          { value: 'research', icon: 'üîç', label: 'Research', desc: 'Understanding & measuring', color: 0xd5d2ff }
        ]
      },
      {
        id: 'services', prompt: 'Which services match your needs?',
        hint: 'Select up to <em>4 services</em>', single: false, maxSelect: 4, items: []
      },
      {
        id: 'goals', prompt: 'What outcomes do you want?',
        hint: 'Select up to <em>3 goals</em>', single: false, maxSelect: 3,
        items: [
          { value: 'awareness', icon: 'üí°', label: 'Build Awareness', desc: 'Spread understanding', color: 0xffebd2 },
          { value: 'behavior', icon: 'üéØ', label: 'Change Behavior', desc: 'Shift actions & habits', color: 0xb15043 },
          { value: 'skills', icon: '‚ö°', label: 'Develop Skills', desc: 'Build capabilities', color: 0x58cbb2 },
          { value: 'evidence', icon: 'üìä', label: 'Generate Evidence', desc: 'Prove impact', color: 0x5872cb },
          { value: 'engagement', icon: '‚ù§Ô∏è', label: 'Drive Engagement', desc: 'Create connection', color: 0xcb7858 }
        ]
      },
      { id: 'summary', prompt: 'Your package is ready', hint: '', single: true, items: [] }
    ];

    const SERVICES_BY_QUADRANT = {
      'people-design': [
        { value: 'trainings', icon: 'üéì', label: 'Trainings', desc: 'Workshops & facilitation', color: 0x5872cb },
        { value: 'learning-experiences', icon: 'üåü', label: 'Learning Experiences', desc: 'Immersive programmes', color: 0x58cbb2 },
        { value: 'programmes', icon: 'üìã', label: 'Programmes', desc: 'Structured journeys', color: 0xcb7858 },
        { value: 'comms-assets', icon: 'üì¢', label: 'Comms Assets', desc: 'Materials that communicate', color: 0xd5d2ff }
      ],
      'people-research': [
        { value: 'programme-evaluation', icon: 'üìä', label: 'Programme Evaluation', desc: 'Measure impact', color: 0x5872cb },
        { value: 'mel-touchpoints', icon: 'üìç', label: 'MEL Touchpoints', desc: 'Monitoring checkpoints', color: 0x58cbb2 },
        { value: 'psychometrics', icon: 'üß†', label: 'Psychometrics', desc: 'Validated assessments', color: 0xd5d2ff },
        { value: 'evidence-for-funders', icon: 'üíº', label: 'Evidence for Funders', desc: 'Proof for stakeholders', color: 0xcb7858 }
      ],
      'product-design': [
        { value: 'learning-tools', icon: 'üõ†Ô∏è', label: 'Learning Tools', desc: 'Educational products', color: 0x5872cb },
        { value: 'toys-games', icon: 'üé≤', label: 'Toys & Games', desc: 'Play-based products', color: 0x58cbb2 },
        { value: 'comms-assets-product', icon: 'üé®', label: 'Comms Assets', desc: 'Brand materials', color: 0xcb7858 },
        { value: 'udl-improvements', icon: '‚ôø', label: 'UDL Improvements', desc: 'Accessibility upgrades', color: 0xd5d2ff }
      ],
      'product-research': [
        { value: 'exhibit-efficacy', icon: 'üèõÔ∏è', label: 'Exhibit Efficacy', desc: 'Does the exhibit work?', color: 0x5872cb },
        { value: 'toy-impacts', icon: 'üéÆ', label: 'Toy Impacts', desc: 'Play value research', color: 0x58cbb2 },
        { value: 'udl-validation', icon: '‚úÖ', label: 'UDL Validation', desc: 'Accessibility testing', color: 0xd5d2ff },
        { value: 'usability-testing', icon: 'üë§', label: 'Usability Testing', desc: 'User experience research', color: 0xcb7858 }
      ]
    };

    const QUADRANT_NAMES = {
      'people-design': 'Design & Deploy',
      'people-research': 'Pinpoint & Prove',
      'product-design': 'Build & Iterate',
      'product-research': 'Test & Validate'
    };

    const GUIDE_LINES = {
      welcome: "Welcome to the studio. Let's configure your experience package together.",
      step1: "First, let's determine your focus. Are you working with people or on a product?",
      step2: "Great choice. Now, what's your approach‚Äîdesign or research?",
      step3: "Perfect. Select the services that match your project needs.",
      step4: "Almost there. What outcomes are you hoping to achieve?",
      step5: "Excellent! Your package is configured. Review it below.",
      goodChoice: ["Good choice.", "That works well.", "Noted.", "Added to your package."]
    };

    const gameState = { step: 1, focus: null, approach: null, services: [], goals: [] };

    // =============================================
    // THREE.JS - BRIGHT STUDIO ENVIRONMENT
    // =============================================
    const canvas = document.getElementById('scene-canvas');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });

    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    // Bright background
    scene.background = new THREE.Color(0x2a3444);

    camera.position.set(0, 2.2, 6);
    camera.lookAt(0, 1.2, 0);

    // =============================================
    // LIGHTING - Bright, well-lit studio
    // =============================================
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
    mainLight.position.set(5, 8, 5);
    mainLight.castShadow = true;
    mainLight.shadow.mapSize.width = 1024;
    mainLight.shadow.mapSize.height = 1024;
    scene.add(mainLight);

    const fillLight = new THREE.DirectionalLight(0xcbe0ff, 0.4);
    fillLight.position.set(-5, 4, 2);
    scene.add(fillLight);

    const accentLight = new THREE.PointLight(0xcb7858, 0.5, 10);
    accentLight.position.set(0, 3, 0);
    scene.add(accentLight);

    // =============================================
    // STUDIO ENVIRONMENT - Walls, Floor, Display
    // =============================================

    // Floor
    const floorGeom = new THREE.PlaneGeometry(20, 15);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x3a4555, roughness: 0.8 });
    const floor = new THREE.Mesh(floorGeom, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // Floor accent line
    const lineGeom = new THREE.PlaneGeometry(8, 0.02);
    const lineMat = new THREE.MeshBasicMaterial({ color: 0xcb7858 });
    const floorLine = new THREE.Mesh(lineGeom, lineMat);
    floorLine.rotation.x = -Math.PI / 2;
    floorLine.position.set(0, 0.01, 2);
    scene.add(floorLine);

    // Back wall
    const wallGeom = new THREE.PlaneGeometry(16, 6);
    const wallMat = new THREE.MeshStandardMaterial({ color: 0x3d4a5c, roughness: 0.9 });
    const backWall = new THREE.Mesh(wallGeom, wallMat);
    backWall.position.set(0, 3, -4);
    backWall.receiveShadow = true;
    scene.add(backWall);

    // Side walls
    const sideWallGeom = new THREE.PlaneGeometry(10, 6);
    const leftWall = new THREE.Mesh(sideWallGeom, wallMat);
    leftWall.position.set(-6, 3, 0);
    leftWall.rotation.y = Math.PI / 2;
    scene.add(leftWall);

    const rightWall = new THREE.Mesh(sideWallGeom, wallMat);
    rightWall.position.set(6, 3, 0);
    rightWall.rotation.y = -Math.PI / 2;
    scene.add(rightWall);

    // Display table/platform
    const tableGeom = new THREE.BoxGeometry(5, 0.1, 1.5);
    const tableMat = new THREE.MeshStandardMaterial({ color: 0x4a5568, roughness: 0.3, metalness: 0.2 });
    const table = new THREE.Mesh(tableGeom, tableMat);
    table.position.set(0, 0.9, 0);
    table.castShadow = true;
    table.receiveShadow = true;
    scene.add(table);

    // Table legs
    const legGeom = new THREE.CylinderGeometry(0.05, 0.05, 0.9, 8);
    const legMat = new THREE.MeshStandardMaterial({ color: 0x4a5568, metalness: 0.3 });
    [[-2, 0.5], [2, 0.5], [-2, -0.5], [2, -0.5]].forEach(([x, z]) => {
      const leg = new THREE.Mesh(legGeom, legMat);
      leg.position.set(x, 0.45, z);
      scene.add(leg);
    });

    // Back wall accent panel
    const panelGeom = new THREE.PlaneGeometry(6, 2);
    const panelMat = new THREE.MeshStandardMaterial({ color: 0x273248, roughness: 0.7 });
    const panel = new THREE.Mesh(panelGeom, panelMat);
    panel.position.set(0, 2.5, -3.95);
    scene.add(panel);

    // Panel glow strip
    const stripGeom = new THREE.PlaneGeometry(5.5, 0.03);
    const stripMat = new THREE.MeshBasicMaterial({ color: 0xcb7858 });
    const strip = new THREE.Mesh(stripGeom, stripMat);
    strip.position.set(0, 3.55, -3.94);
    scene.add(strip);

    // =============================================
    // GUIDE CHARACTER - Human-like curator
    // =============================================
    const guide = new THREE.Group();

    // Body
    const bodyGeom = new THREE.CylinderGeometry(0.25, 0.3, 1.2, 12);
    const bodyMat = new THREE.MeshStandardMaterial({ color: 0x4a5568, roughness: 0.6 });
    const body = new THREE.Mesh(bodyGeom, bodyMat);
    body.position.y = 0.8;
    body.castShadow = true;
    guide.add(body);

    // Torso accent
    const vestGeom = new THREE.CylinderGeometry(0.26, 0.28, 0.5, 12);
    const vestMat = new THREE.MeshStandardMaterial({ color: 0x273248, roughness: 0.5 });
    const vest = new THREE.Mesh(vestGeom, vestMat);
    vest.position.y = 1.1;
    guide.add(vest);

    // Head
    const headGeom = new THREE.SphereGeometry(0.2, 16, 16);
    const headMat = new THREE.MeshStandardMaterial({ color: 0xd4b896, roughness: 0.7 });
    const head = new THREE.Mesh(headGeom, headMat);
    head.position.y = 1.65;
    head.castShadow = true;
    guide.add(head);

    // Hair
    const hairGeom = new THREE.SphereGeometry(0.21, 16, 8, 0, Math.PI * 2, 0, Math.PI * 0.5);
    const hairMat = new THREE.MeshStandardMaterial({ color: 0x3d3d3d, roughness: 0.8 });
    const hair = new THREE.Mesh(hairGeom, hairMat);
    hair.position.y = 1.7;
    guide.add(hair);

    // Eyes (simple dots)
    const eyeGeom = new THREE.SphereGeometry(0.025, 8, 8);
    const eyeMat = new THREE.MeshBasicMaterial({ color: 0x273248 });
    const leftEye = new THREE.Mesh(eyeGeom, eyeMat);
    leftEye.position.set(-0.07, 1.67, 0.17);
    guide.add(leftEye);
    const rightEye = new THREE.Mesh(eyeGeom, eyeMat);
    rightEye.position.set(0.07, 1.67, 0.17);
    guide.add(rightEye);

    // Arms
    const armGeom = new THREE.CylinderGeometry(0.06, 0.05, 0.6, 8);
    const armMat = new THREE.MeshStandardMaterial({ color: 0x4a5568, roughness: 0.6 });
    const leftArm = new THREE.Mesh(armGeom, armMat);
    leftArm.position.set(-0.35, 1, 0);
    leftArm.rotation.z = 0.3;
    guide.add(leftArm);
    const rightArm = new THREE.Mesh(armGeom, armMat);
    rightArm.position.set(0.35, 1, 0);
    rightArm.rotation.z = -0.3;
    rightArm.name = 'rightArm';
    guide.add(rightArm);

    // Hands
    const handGeom = new THREE.SphereGeometry(0.06, 8, 8);
    const handMat = new THREE.MeshStandardMaterial({ color: 0xd4b896, roughness: 0.7 });
    const leftHand = new THREE.Mesh(handGeom, handMat);
    leftHand.position.set(-0.5, 0.75, 0);
    guide.add(leftHand);
    const rightHand = new THREE.Mesh(handGeom, handMat);
    rightHand.position.set(0.5, 0.75, 0.1);
    rightHand.name = 'rightHand';
    guide.add(rightHand);

    // Tablet in hand
    const tabletGeom = new THREE.BoxGeometry(0.2, 0.3, 0.02);
    const tabletMat = new THREE.MeshStandardMaterial({ color: 0x1a1a2e, roughness: 0.3 });
    const tablet = new THREE.Mesh(tabletGeom, tabletMat);
    tablet.position.set(0.5, 0.8, 0.15);
    tablet.rotation.y = -0.3;
    tablet.rotation.x = -0.2;
    guide.add(tablet);

    // Tablet screen glow
    const screenGeom = new THREE.PlaneGeometry(0.15, 0.22);
    const screenMat = new THREE.MeshBasicMaterial({ color: 0x58cbb2, transparent: true, opacity: 0.6 });
    const screen = new THREE.Mesh(screenGeom, screenMat);
    screen.position.set(0.5, 0.8, 0.17);
    screen.rotation.y = -0.3;
    screen.rotation.x = -0.2;
    guide.add(screen);

    guide.position.set(-2.8, 0, 1);
    guide.rotation.y = 0.4;
    scene.add(guide);

    // =============================================
    // HOLOGRAPHIC DISPLAY ITEMS
    // =============================================
    const itemObjects = [];
    const itemDataMap = new Map();
    const displayBases = [];

    function createDisplayBase() {
      const group = new THREE.Group();
      const baseGeom = new THREE.CylinderGeometry(0.25, 0.28, 0.05, 16);
      const baseMat = new THREE.MeshStandardMaterial({ color: 0x5a6577, roughness: 0.4, metalness: 0.3 });
      const base = new THREE.Mesh(baseGeom, baseMat);
      group.add(base);

      // Glow ring
      const ringGeom = new THREE.TorusGeometry(0.26, 0.01, 8, 32);
      const ringMat = new THREE.MeshBasicMaterial({ color: 0x58cbb2, transparent: true, opacity: 0.6 });
      const ring = new THREE.Mesh(ringGeom, ringMat);
      ring.rotation.x = Math.PI / 2;
      ring.position.y = 0.03;
      group.add(ring);

      return group;
    }

    function createHoloItem(type, color) {
      const group = new THREE.Group();

      if (type === 'crystal') {
        const geom = new THREE.OctahedronGeometry(0.15, 0);
        const mat = new THREE.MeshStandardMaterial({
          color: color, emissive: color, emissiveIntensity: 0.3,
          transparent: true, opacity: 0.85, roughness: 0.2
        });
        group.add(new THREE.Mesh(geom, mat));
      } else if (type === 'cube') {
        const geom = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const mat = new THREE.MeshStandardMaterial({
          color: color, emissive: color, emissiveIntensity: 0.2,
          transparent: true, opacity: 0.85, roughness: 0.3
        });
        group.add(new THREE.Mesh(geom, mat));
      } else if (type === 'sphere') {
        const geom = new THREE.SphereGeometry(0.12, 16, 16);
        const mat = new THREE.MeshStandardMaterial({
          color: color, emissive: color, emissiveIntensity: 0.25,
          transparent: true, opacity: 0.85, roughness: 0.25
        });
        group.add(new THREE.Mesh(geom, mat));

        // Ring
        const ringGeom = new THREE.TorusGeometry(0.18, 0.015, 8, 32);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.4 });
        const ring = new THREE.Mesh(ringGeom, ringMat);
        ring.rotation.x = Math.PI * 0.3;
        group.add(ring);
      } else if (type === 'gem') {
        const geom = new THREE.IcosahedronGeometry(0.14, 0);
        const mat = new THREE.MeshStandardMaterial({
          color: color, emissive: color, emissiveIntensity: 0.3,
          transparent: true, opacity: 0.85, roughness: 0.2
        });
        group.add(new THREE.Mesh(geom, mat));
      }

      return group;
    }

    function positionItems() {
      itemObjects.forEach(obj => scene.remove(obj));
      displayBases.forEach(base => scene.remove(base));
      itemObjects.length = 0;
      displayBases.length = 0;
      itemDataMap.clear();

      const step = STEPS[gameState.step];
      if (!step || gameState.step === 5) return;

      let items = step.items;
      if (gameState.step === 3 && gameState.focus && gameState.approach) {
        items = SERVICES_BY_QUADRANT[`${gameState.focus}-${gameState.approach}`] || [];
        STEPS[3].items = items;
      }

      const count = items.length;
      const spacing = Math.min(1.0, 4 / count);
      const startX = -(count - 1) * spacing / 2;

      items.forEach((item, i) => {
        // Display base
        const base = createDisplayBase();
        base.position.set(startX + i * spacing, 0.95, 0);
        scene.add(base);
        displayBases.push(base);

        // Floating item
        const types = ['crystal', 'cube', 'sphere', 'gem'];
        const holoItem = createHoloItem(types[gameState.step - 1] || 'crystal', item.color);
        holoItem.position.set(startX + i * spacing, 1.35, 0);
        holoItem.userData = { ...item, index: i, baseRef: base };
        itemDataMap.set(holoItem.uuid, item);

        holoItem.traverse(child => {
          child.userData.draggable = true;
          child.userData.itemData = item;
          child.userData.parentGroup = holoItem;
        });

        scene.add(holoItem);
        itemObjects.push(holoItem);
      });
    }

    // =============================================
    // INTERACTION
    // =============================================
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let hoveredItem = null, draggedItemData = null, draggedMesh = null, draggingElement = null;

    function onMouseMove(e) {
      mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
      if (hoveredItem && !draggedItemData) {
        const label = document.getElementById('itemLabel');
        label.style.left = e.clientX + 'px';
        label.style.top = e.clientY + 'px';
      }
      if (draggingElement) {
        draggingElement.style.left = e.clientX + 'px';
        draggingElement.style.top = e.clientY + 'px';
        updateDropTargets(e.clientX, e.clientY);
      }
    }

    function updateDropTargets(x, y) {
      const step = STEPS[gameState.step];
      if (!step) return;
      document.querySelectorAll(`.inventory-slot[data-section="${step.id}"]`).forEach(slot => {
        const r = slot.getBoundingClientRect();
        slot.classList.toggle('drop-target', x >= r.left && x <= r.right && y >= r.top && y <= r.bottom && !slot.classList.contains('filled'));
      });
    }

    function onMouseDown(e) {
      if (e.button !== 0 || gameState.step === 5) return;
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(itemObjects, true);
      for (const hit of intersects) {
        let obj = hit.object;
        while (obj && !obj.userData.itemData) obj = obj.parent;
        if (obj?.userData.itemData) {
          const data = obj.userData.itemData;
          const step = STEPS[gameState.step];
          if (step.single && gameState[step.id] === data.value) return;
          if (!step.single && (gameState[step.id].includes(data.value) || gameState[step.id].length >= step.maxSelect)) return;

          draggedItemData = data;
          draggedMesh = obj.userData.parentGroup || obj;
          draggingElement = document.createElement('div');
          draggingElement.className = 'dragging-item';
          draggingElement.textContent = data.icon;
          draggingElement.style.left = e.clientX + 'px';
          draggingElement.style.top = e.clientY + 'px';
          document.body.appendChild(draggingElement);
          document.body.classList.add('dragging');
          document.getElementById('itemLabel').classList.remove('visible');
          draggedMesh.traverse(c => { if (c.material) { c.material.transparent = true; c.material.opacity = 0.3; }});
          break;
        }
      }
    }

    function onMouseUp(e) {
      if (!draggedItemData) return;
      const step = STEPS[gameState.step];
      let dropped = false;
      document.querySelectorAll(`.inventory-slot[data-section="${step.id}"]`).forEach(slot => {
        const r = slot.getBoundingClientRect();
        if (e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom && !slot.classList.contains('filled')) {
          dropped = true;
          if (step.single) gameState[step.id] = draggedItemData.value;
          else gameState[step.id].push(draggedItemData.value);
          slot.classList.add('filled');
          slot.innerHTML = `<div class="slot-item">${draggedItemData.icon}</div><div class="slot-tooltip">${draggedItemData.label}</div>`;
          showGuide(GUIDE_LINES.goodChoice[Math.floor(Math.random() * GUIDE_LINES.goodChoice.length)]);
          scene.remove(draggedMesh);
          if (draggedMesh.userData.baseRef) { scene.remove(draggedMesh.userData.baseRef); displayBases.splice(displayBases.indexOf(draggedMesh.userData.baseRef), 1); }
          itemObjects.splice(itemObjects.indexOf(draggedMesh), 1);
          checkStepComplete();
        }
        slot.classList.remove('drop-target');
      });
      if (!dropped && draggedMesh) draggedMesh.traverse(c => { if (c.material) c.material.opacity = 0.85; });
      if (draggingElement) { draggingElement.remove(); draggingElement = null; }
      document.body.classList.remove('dragging');
      draggedItemData = draggedMesh = null;
    }

    function checkHover() {
      if (draggedItemData || gameState.step === 5) return;
      raycaster.setFromCamera(mouse, camera);
      const hits = raycaster.intersectObjects(itemObjects, true);
      const label = document.getElementById('itemLabel');
      let found = null;
      for (const h of hits) {
        let o = h.object;
        while (o && !o.userData.itemData) o = o.parent;
        if (o?.userData.itemData) { found = o.userData.itemData; break; }
      }
      if (found) {
        if (hoveredItem !== found) {
          hoveredItem = found;
          label.querySelector('.item-label-name').textContent = found.label;
          label.querySelector('.item-label-desc').textContent = found.desc;
          label.classList.add('visible');
        }
        canvas.style.cursor = 'grab';
      } else {
        if (hoveredItem) { hoveredItem = null; label.classList.remove('visible'); }
        canvas.style.cursor = 'default';
      }
    }

    // =============================================
    // GAME FLOW
    // =============================================
    function checkStepComplete() {
      const step = STEPS[gameState.step];
      if (step.single && gameState[step.id]) setTimeout(advanceStep, 500);
      else document.getElementById('continueBtn').classList.toggle('visible', gameState[step.id]?.length > 0);
    }

    function advanceStep() {
      if (gameState.step >= 5) return;
      gameState.step++;
      document.getElementById('continueBtn').classList.remove('visible');
      updateUI();
      positionItems();
      if (gameState.step === 5) showPackageSummary();
      else showGuide(GUIDE_LINES[`step${gameState.step}`] || GUIDE_LINES.welcome);
    }

    function updateUI() {
      document.querySelectorAll('.step-pip').forEach(p => {
        const s = parseInt(p.dataset.step);
        p.classList.toggle('active', s === gameState.step);
        p.classList.toggle('complete', s < gameState.step);
      });
      const step = STEPS[gameState.step];
      if (step && gameState.step < 5) {
        document.getElementById('stagePrompt').querySelector('.prompt-step').textContent = `step ${gameState.step} of 5`;
        document.getElementById('stagePrompt').querySelector('.prompt-question').textContent = step.prompt;
        document.getElementById('stagePrompt').querySelector('.prompt-hint').innerHTML = step.hint;
        document.getElementById('stagePrompt').style.display = 'block';
      } else {
        document.getElementById('stagePrompt').style.display = 'none';
      }
      document.querySelectorAll('.inventory-section').forEach(sec => {
        const id = sec.id.replace('section-', '');
        const num = ['focus', 'approach', 'services', 'goals'].indexOf(id) + 1;
        sec.style.opacity = num <= gameState.step ? '1' : '0.4';
      });
    }

    function showGuide(text) {
      const el = document.getElementById('wizardSpeech');
      document.getElementById('wizardText').textContent = text;
      el.classList.add('visible');
      clearTimeout(window.guideTimeout);
      window.guideTimeout = setTimeout(() => el.classList.remove('visible'), 4000);
    }

    function showPackageSummary() {
      showGuide(GUIDE_LINES.step5);
      const quadrant = `${gameState.focus}-${gameState.approach}`;
      document.getElementById('packageQuadrant').textContent = QUADRANT_NAMES[quadrant] || '';
      const focusItem = STEPS[1].items.find(i => i.value === gameState.focus);
      const approachItem = STEPS[2].items.find(i => i.value === gameState.approach);
      document.getElementById('summaryFocus').textContent = focusItem ? `${focusItem.icon} ${focusItem.label}` : '‚Äî';
      document.getElementById('summaryApproach').textContent = approachItem ? `${approachItem.icon} ${approachItem.label}` : '‚Äî';
      document.getElementById('summaryServices').innerHTML = gameState.services.map(v => {
        const item = STEPS[3].items.find(i => i.value === v);
        return item ? `<span class="package-tag">${item.icon} ${item.label}</span>` : '';
      }).join('');
      document.getElementById('summaryGoals').innerHTML = gameState.goals.map(v => {
        const item = STEPS[4].items.find(i => i.value === v);
        return item ? `<span class="package-tag">${item.icon} ${item.label}</span>` : '';
      }).join('');
      document.getElementById('inventoryPouch').style.display = 'none';
      document.getElementById('packageSummary').classList.add('visible');
    }

    function resetGame() {
      gameState.step = 1;
      gameState.focus = gameState.approach = null;
      gameState.services = [];
      gameState.goals = [];
      document.querySelectorAll('.inventory-slot').forEach(s => { s.classList.remove('filled'); s.innerHTML = ''; });
      document.getElementById('packageSummary').classList.remove('visible');
      document.getElementById('inventoryPouch').style.display = 'block';
      document.getElementById('continueBtn').classList.remove('visible');
      updateUI();
      positionItems();
      showGuide(GUIDE_LINES.welcome);
    }

    // =============================================
    // ANIMATION
    // =============================================
    let time = 0;
    function animate() {
      requestAnimationFrame(animate);
      time += 0.016;

      // Float items
      itemObjects.forEach((obj, i) => {
        obj.position.y = 1.35 + Math.sin(time * 1.5 + i * 0.8) * 0.05;
        obj.rotation.y += 0.005;
      });

      // Guide subtle animation
      guide.rotation.y = 0.4 + Math.sin(time * 0.5) * 0.05;
      const rh = guide.getObjectByName('rightHand');
      if (rh) rh.position.y = 0.75 + Math.sin(time * 0.8) * 0.02;

      checkHover();
      renderer.render(scene, camera);
    }

    // =============================================
    // EVENTS
    // =============================================
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mousedown', onMouseDown);
    window.addEventListener('mouseup', onMouseUp);
    document.getElementById('continueBtn').addEventListener('click', advanceStep);
    document.getElementById('resetBtn').addEventListener('click', resetGame);
    document.getElementById('submitBtn').addEventListener('click', () => {
      const params = new URLSearchParams({
        focus: gameState.focus, approach: gameState.approach,
        services: gameState.services.join(','), goals: gameState.goals.join(',')
      });
      window.location.href = `../connect/?${params.toString()}`;
    });
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // INIT
    updateUI();
    positionItems();
    showGuide(GUIDE_LINES.welcome);
    animate();
  </script>
</body>
</html>
